<html>

<head>
  <title>Video Chat</title>
</head>

<body>
  <p>
    <input type="text" id="name" placeholder="Name" />
    <button id="set_name_btn">Set name</button>
  </p>
  <p>
    <input type="text" id="cid" placeholder="Coference ID" />
    <button id="new_room_btn">New conference</button>
    <button id="connect_btn">Connect</button>
    <button id="hang_btn" disabled>Hang</button>
  </p>
  <div id="remoteVideos"></div> <br />


  <script src="socket.io.dev.js"></script>
  <script>
    var clientId;
    var roomId;
    var offer = null;

    let base_url = "http://localhost:3000";
    let ws_url = "ws://localhost:3000/";

    async function joinRoom() {
      var remoteICE = []
      var hasRemoteOffer = false
      const socket = io(ws_url, {
        transports: ['websocket']
      });
      socket.on("connect", async () => {
        console.log("Socket connected");
        await socket.emit("handshake", JSON.stringify(
          {
            "roomId": roomId,
            "uid": clientId
          }
        ));

        let pc = new RTCPeerConnection({
          iceServers: [
            {
              urls: 'stun:localhost:3478',
              username: "guest",
              credential: "guest"
            },
            {
              urls: "turn:localhost:3478",
              username: "guest",
              credential: "guest"
            }
          ]
        });

        pc.oniceconnectionstatechange = e => {
          console.log(e)
          console.log(pc.iceConnectionState)
          if (pc.iceConnectionState == "connected") {
            document.getElementById("hang_btn").disabled = false
          }
        }

        pc.onnegotiationneeded = () => {
          console.log("negotiation needed");
        }

        pc.ontrack = function (event) {
          console.log("New track");
          console.log(event)
          var el = document.createElement(event.track.kind)
          el.srcObject = event.streams[0]
          el.autoplay = true
          el.controls = false 
          el.width = 200

          document.getElementById('remoteVideos').appendChild(el)
        }

        pc.onicecandidate = async (event) => {
          if (event.candidate !== null) {
            console.log("New candidate");
            console.log(event.candidate);
            let cand = btoa(JSON.stringify(event.candidate));
            await socket.emit("exchange_ice", JSON.stringify({
              "roomId": roomId,
              "uid": clientId,
              "ice": cand
            }));
          } else {
            console.log("Finished gathering candidates");
          }
        }

        pc.onaddstream = (evt) => console.log(evt);

        socket.on('exchange_ice', (msg) => {
          console.log("New remote ICE candidate");
          var enc = new TextDecoder("utf-8");
          var ice = JSON.parse(atob(enc.decode(msg)));
          console.log(ice);
          if (hasRemoteOffer) {
            pc.addIceCandidate(ice).catch(err => {
              console.warn("Failed to add remote ICE candidate");
              console.warn(err);

            });
          } else {
            remoteICE.push(ice);
          }
        });

        socket.on('remote_offer', async (msg) => {
          console.log("Got offer");
          var enc = new TextDecoder("utf-8");
          // console.log(enc.decode(msg));
          var data = JSON.parse(enc.decode(msg))
          var descr = JSON.parse(atob(data.data));
          console.log(descr);
          var rtcDescr = new RTCSessionDescription(descr);
          pc.setRemoteDescription(rtcDescr).catch(err => {
            console.warn("Failed to set remote description");
            console.warn(err)
          })
          remoteICE.forEach((ice) => pc.addIceCandidate(ice));
          // console.log(pc.remoteDescription);
        });

        document.getElementById("hang_btn").onclick = function () {
          document.getElementById("hang_btn").disabled = true;
          document.getElementById("remoteVideos").textContent = ''
          pc.close();
          socket.emit("leave_room", JSON.stringify({
            "roomId": roomId,
            "uid": clientId
          }))
          socket.close();
          
          // TODO close socket
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          console.log("Created stream");
          stream.getTracks().forEach((track) => {
            pc.addTrack(track, stream)
            var el = document.createElement(track.kind)
            el.srcObject = new MediaStream([track])
            el.autoplay = true
            el.controls = false
            el.width = 200
            track.onmute = () => el.srcObject = null;

            document.getElementById('remoteVideos').appendChild(el)
          });
          pc.addTransceiver("video");
          pc.addTransceiver("video");
          pc.addTransceiver("video");
          pc.addTransceiver("video");
          await pc.setLocalDescription(await pc.createOffer());
          let offer = btoa(JSON.stringify(pc.localDescription));
          console.log(pc.localDescription)
          console.log("Local offer");
          console.log(offer);
          await socket.emit('join_room', JSON.stringify({
            "roomId": roomId,
            "uid": clientId,
            "offer": offer
          }));
          console.log("Sent offer");
        } catch (err) {
          console.log(err);
        }
      });
      socket.connect();
    }

    document.getElementById("set_name_btn").onclick = function () {
      var http = new XMLHttpRequest();
      var url = base_url + "/user/create";
      var params = "name=\"" + document.getElementById("name").value + "\"";
      http.open('POST', url, true);
      http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      http.onreadystatechange = function () {
        if (http.readyState == 4 && http.status == 200) {
          console.log(http.responseText);
          var data = JSON.parse(http.responseText);
          clientId = data.id;
        }
      }
      http.send(params);
    }

    document.getElementById("new_room_btn").onclick = function () {
      var http = new XMLHttpRequest();
      var url = base_url + "/rooms/create";
      var params = "uid=\"" + clientId + "\"";
      http.open('POST', url, true);
      http.onreadystatechange = function () {
        if (http.readyState == 4 && http.status == 200) {
          console.log(http.responseText);
          var data = JSON.parse(http.responseText);
          roomId = data.id;
          document.getElementById("cid").value = roomId;
          joinRoom();
        }
      }
      http.send(params);

    }

    document.getElementById("connect_btn").onclick = function () {
      roomId = document.getElementById("cid").value;
      joinRoom();
    }
  </script>
</body>

</html>
