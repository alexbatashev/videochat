version: "3.2"
services:
  rest:
    build: rest_server
    restart: on-failure
    ports:
      - "3000:3000"
    depends_on:
      - tarantool
      - mongo
      - rabbitmq
      - prometheus
      - nginx
      - sfu
  sfu:
    build: sfu_server
    restart: on-failure
    depends_on:
      - rabbitmq
      - prometheus
  tarantool:
    build:
      context: .
      dockerfile: Dockerfile.tarantool
    command: tarantool /usr/local/share/tarantool/tarantool_init.lua
    environment:
      TARANTOOL_USER_NAME: "tarantool"
      TARANTOOL_USER_PASSWORD: "tarantoolpwd"
  mongo:
    image: "mongo"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
  rabbitmq:
    image: "rabbitmq:3.8.9-management-alpine"
    ports:
      - 8080:15672
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:15672"]
      interval: 30s
      timeout: 10s
      retries: 5
  prometheus:
    image: "bitnami/prometheus"
  grafana:
    image: "grafana/grafana"
    ports:
      - "3005:3000"
  turn:
    # build: turn
    image: "instrumentisto/coturn"
    command: ["-n", "--log-file=stdout", "--min-port=49160", "--max-port=49200", "--lt-cred-mech", "--no-multicast-peers", "--no-cli", "--no-tlsv1", "--no-tlsv1_1", "--realm=localhost"]
    ports:
      - "3478:3478"
      - "3478:3478/udp"
      - "49160-49200:49160-49200/udp"
  nginx:
    build: 
      context: .
      dockerfile: "Dockerfile.nginx"
    ports:
      - "80:80"
    depends_on:
      - turn 
